<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>HeartBloom for Mona 💖</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-start: #0b0b1a;
            --bg-end: #1a1a2e;
            --header-color: #ffb3c6;
            --subtitle-color: #ffd4e5;
            --caption-color: rgba(255, 255, 255, 0.6);
            --message-color: #ffe066;
            --heart-color-1: #ff69b4;
            --heart-color-2: #ff1493;
            --pot-color-1: #a0522d;
            --pot-color-2: #8b4513;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            height: 100%;
            width: 100%;
            overflow: hidden;
        }

        body {
            font-family: 'Cairo', sans-serif;
            background: linear-gradient(135deg, var(--bg-start) 0%, var(--bg-end) 100%);
            color: white;
            touch-action: manipulation;
        }

        /* --- Screens & Layout --- */
        .screen {
            position: fixed;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 0.8s ease-out;
        }

        #start-screen {
            background: rgba(11, 11, 26, 0.9);
            backdrop-filter: blur(10px);
            z-index: 2000;
            text-align: center;
            padding: 20px;
        }

        .container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            padding: 20px;
        }
        
        /* --- UI Elements --- */
        .gemini-button, #start-button {
            background: linear-gradient(45deg, var(--heart-color-1), var(--heart-color-2));
            color: white;
            font-size: 20px;
            font-family: 'Cairo', sans-serif;
            font-weight: bold;
            padding: 15px 30px;
            border-radius: 50px;
            border: none;
            cursor: pointer;
            box-shadow: 0 0 20px rgba(255, 20, 147, 0.6);
            transition: transform 0.3s, box-shadow 0.3s;
        }
        .gemini-button:hover, #start-button:hover {
            transform: scale(1.1);
            box-shadow: 0 0 30px rgba(255, 20, 147, 0.8);
        }
        .gemini-button {
            margin-top: 10px;
            font-size: 16px;
            padding: 12px 25px;
            display: none; /* Hidden by default */
        }
        .gemini-button.show {
            display: inline-block;
            animation: fadeIn 1s ease-out;
        }

        .header { text-align: center; z-index: 10; flex-shrink: 0; }
        .title {
            font-size: clamp(36px, 10vw, 48px);
            font-weight: 700;
            color: var(--header-color);
            text-shadow: 0 0 20px rgba(255, 179, 198, 0.5);
        }
        .subtitle { font-size: clamp(22px, 6vw, 28px); font-style: italic; color: var(--subtitle-color); opacity: 0.8; }
        .caption { font-size: 16px; color: var(--caption-color); margin-top: 5px; }

        .interaction-area {
            flex-grow: 1;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        .message-container {
            width: 90%;
            max-width: 500px;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .message {
            font-size: clamp(18px, 4vw, 22px);
            color: var(--message-color);
            text-align: center;
            text-shadow: 0 0 10px rgba(255, 224, 102, 0.5);
            transition: opacity 0.5s, transform 0.5s;
            opacity: 0;
            transform: translateY(20px);
        }
        .message.show { opacity: 1; transform: translateY(0); }
        .message.loading { font-style: italic; opacity: 0.7; }

        .heart-container { margin-top: 20px; cursor: pointer; }

        #heart {
            width: clamp(120px, 40vw, 150px);
            height: auto;
            filter: drop-shadow(0 0 25px rgba(255, 105, 180, 0.8));
            animation: pulse 1.8s ease-in-out infinite;
            transition: transform 0.2s;
        }
        #heart:active { transform: scale(0.9); transition: transform 0.1s; }

        @keyframes pulse {
            0%, 100% { transform: scale(1); filter: drop-shadow(0 0 25px rgba(255, 105, 180, 0.8)); }
            50% { transform: scale(0.95); filter: drop-shadow(0 0 40px rgba(255, 105, 180, 1)); }
        }
        
        .flower-section {
            width: 100%;
            flex-shrink: 0;
            text-align: center;
        }

        .flower-container {
            position: relative;
            width: 150px;
            height: 250px;
            margin: 0 auto;
            cursor: pointer;
        }
        .flower-container::before {
             content: 'انقري هنا لرعاية بذرة حبنا';
             position: absolute;
             bottom: -15px;
             width: 100%;
             text-align: center;
             font-size: 12px;
             color: var(--caption-color);
             opacity: 0;
             transition: opacity 0.3s;
             pointer-events: none;
        }
        .flower-container:hover::before { opacity: 1; }

        #pot { width: 120px; position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); transform-origin: bottom center; }
        #flower { position: absolute; bottom: 80px; left: 50%; transform: translateX(-50%); transform-origin: bottom center; transition: all 0.5s ease; }
        .flower-stage { transition: opacity 0.5s; transform-origin: 50% 90%; }
        
        @keyframes grow { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        @keyframes pot-tap { 50% { transform: translateX(-50%) scale(0.97); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .flying-heart { position: absolute; width: 30px; height: 30px; pointer-events: none; z-index: 1000; }

        .bloom-message, #poem-modal { background: rgba(0,0,0,0.8); text-align: center; font-size: 24px; font-weight: 700; color: #ff4d94; text-shadow: 0 0 20px rgba(255, 77, 148, 0.8); opacity: 0; pointer-events: none; z-index: 1000; line-height: 1.8; white-space: pre-line; transition: opacity 2s ease; }
        .bloom-message.show { opacity: 1; }
        
        #poem-modal { z-index: 1500; transition: opacity 0.5s ease; }
        #poem-modal.show { opacity: 1; pointer-events: auto; }
        .modal-content { max-width: 500px; padding: 40px; position: relative; }
        .close-modal { position: absolute; top: 15px; right: 20px; font-size: 30px; cursor: pointer; color: white; }
        #poem-text { font-size: clamp(18px, 4vw, 22px); }

        .ui-element { position: fixed; background: rgba(255, 255, 255, 0.1); padding: 8px 15px; border-radius: 20px; color: white; font-size: 14px; backdrop-filter: blur(10px); user-select: none; z-index: 100; }
        #tapCounter { top: 10px; left: 10px; }
        #musicControl { top: 10px; right: 10px; cursor: pointer; }
    </style>
</head>
<body>

    <div id="start-screen" class="screen">
        <h1 class="title" style="font-size: 3.5rem; margin-bottom: 20px;">💖 رسالة إلى مونه 💖</h1>
        <div style="max-width: 400px; line-height: 1.8;">
            <p class="subtitle" style="margin-bottom: 20px;">أهلاً بكِ في عالمي الصغير الذي صنعته خصيصاً لكِ.</p>
            <p class="caption" style="font-size: 18px; margin-bottom: 30px;">
                الآن، أصبح القلب شاعراً... كل نقرة عليه ستلهم الذكاء الاصطناعي ليكتب لكِ رسالة حب فريدة.
                <br>
                وعندما تكتمل زهرتنا، سيُكتب لكِ قصيدة خاصة.
            </p>
        </div>
        <button id="start-button">ابدئي الرحلة</button>
        <p class="caption" style="margin-top: 30px;">(يرجى التأكد من رفع صوت الجهاز 🎵)</p>
    </div>

    <div class="container">
        <header class="header">
            <h1 class="title">إيمان</h1>
            <h2 class="subtitle">مونه</h2>
        </header>

        <div class="interaction-area">
            <div class="message-container">
                <p class="message" id="message">اضغطي على القلب لتلهمي الشاعر 💖</p>
            </div>
            <div class="heart-container" id="heart-touch-area">
                <svg id="heart" viewBox="0 0 32 29.6">
                    <defs><linearGradient id="heartGradient" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:var(--heart-color-1);" /><stop offset="100%" style="stop-color:var(--heart-color-2);" /></linearGradient></defs>
                    <path fill="url(#heartGradient)" d="M23.6,0c-3.4,0-6.3,2.7-7.6,5.6C14.7,2.7,11.8,0,8.4,0C3.8,0,0,3.8,0,8.4c0,9.4,9.5,11.9,16,21.2c6.1-9.3,16-12.1,16-21.2C32,3.8,28.2,0,23.6,0z"/>
                </svg>
            </div>
        </div>

        <div class="flower-section">
            <div class="flower-container" id="flower-touch-area">
                <svg id="pot" viewBox="0 0 100 80">
                     <defs><linearGradient id="potGradient" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" style="stop-color:var(--pot-color-1)" /><stop offset="100%" style="stop-color:var(--pot-color-2)" /></linearGradient></defs>
                    <path d="M10 80 H90 L80 10 H20 L10 80 Z" fill="url(#potGradient)"/><path d="M5 12 H95 V20 H5 V12 Z" fill="#654321"/>
                </svg>
                <svg id="flower" viewBox="0 0 100 100">
                    <g class="flower-stage" id="stage0"><circle cx="50" cy="85" r="8" fill="#A0522D"/></g>
                    <g class="flower-stage" id="stage1" style="opacity:0"><path d="M50 90 C 50 70, 40 70, 40 50 S 50 30, 50 10" stroke="#228B22" stroke-width="3" fill="none"/></g>
                    <g class="flower-stage" id="stage2" style="opacity:0"><path d="M50 90 V 30" stroke="#228B22" stroke-width="4" fill="none"/><path d="M50 70 C 70 60, 75 50, 85 45" stroke="#32CD32" stroke-width="3" fill="none"/><path d="M50 60 C 30 55, 25 45, 15 40" stroke="#32CD32" stroke-width="3" fill="none"/></g>
                    <g class="flower-stage" id="stage3" style="opacity:0"><use href="#stage2" /><circle cx="50" cy="25" r="10" fill="#FFC0CB"/></g>
                    <g class="flower-stage" id="stage4" style="opacity:0"><use href="#stage2" /><path d="M50,25 m -15,0 a 15,15 0 1,0 30,0 a 15,15 0 1,0 -30,0" fill="#FF69B4" /><circle cx="50" cy="25" r="7" fill="yellow"/></g>
                    <g class="flower-stage" id="stage5" style="opacity:0"><use href="#stage2" /><path transform="translate(50 25) scale(1.2)" d="M0,-15 A15 15 0 0 1 0,15 A15 15 0 0 1 0,-15 M-15,0 A15 15 0 0 1 15,0 A15 15 0 0 1 -15,0" fill="#FF1493"/><circle cx="50" cy="25" r="8" fill="#FFFF00"/></g>
                </svg>
            </div>
            <button id="poem-button" class="gemini-button">✨ اطلب قصيدة خاصة</button>
        </div>
    </div>

    <div class="bloom-message screen" id="bloomMessage">
        You made my life bloom 🌸
        إيمان 💖
        كل نبضة كانت ليكِ يا مونه 🌷
        حلم حياتي ♥
    </div>

    <div id="poem-modal" class="screen">
        <div class="modal-content">
            <span class="close-modal" id="close-poem-modal">&times;</span>
            <p id="poem-text">جاري كتابة قصيدة تليق بكِ...</p>
        </div>
    </div>

    <div class="tap-counter ui-element" id="tapCounter">نمو الزهرة: 0/15</div>
    <div class="music-control ui-element" id="musicControl">🎵 تشغيل الموسيقى</div>
    
    <!-- IMPORTANT: Place your 'helm_hayaty.mp3' file in the same folder as this HTML file. -->
    <audio id="backgroundMusic" loop src="helm_hayaty.mp3"></audio>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            let potTapCount = 0, flowerStage = 0, isBloomed = false, musicPlaying = false, isGenerating = false;
            let typewriterInterval;
            
            // --- Gemini API Configuration ---
            const API_KEY = ""; // Leave empty, it will be handled by the environment
            const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`;

            const DOM = {
                startScreen: document.getElementById('start-screen'),
                startButton: document.getElementById('start-button'),
                heartTouchArea: document.getElementById('heart-touch-area'),
                flowerTouchArea: document.getElementById('flower-touch-area'),
                messageEl: document.getElementById('message'),
                bloomMessageEl: document.getElementById('bloomMessage'),
                tapCounterEl: document.getElementById('tapCounter'),
                musicControlEl: document.getElementById('musicControl'),
                backgroundMusic: document.getElementById('backgroundMusic'),
                pot: document.getElementById('pot'),
                poemButton: document.getElementById('poem-button'),
                poemModal: document.getElementById('poem-modal'),
                poemText: document.getElementById('poem-text'),
                closePoemModal: document.getElementById('close-poem-modal'),
                flowerStages: Array.from({length: 6}, (_, i) => document.getElementById(`stage${i}`)),
            };

            // --- Typewriter Effect ---
            function typewriter(element, text) {
                clearInterval(typewriterInterval);
                const words = text.split(' ');
                let i = 0;
                element.textContent = '';
                element.classList.remove('loading');
                element.classList.add('show');

                typewriterInterval = setInterval(() => {
                    if (i < words.length) {
                        element.textContent += words[i] + ' ';
                        i++;
                    } else {
                        clearInterval(typewriterInterval);
                    }
                }, 120); // Typing speed
            }

            // --- Gemini API Call Function ---
            async function generateGeminiContent(prompt, retries = 3, delay = 1000) {
                isGenerating = true;
                try {
                    const payload = { contents: [{ parts: [{ text: prompt }] }] };
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (!text) throw new Error("No content generated.");
                    return text.trim();
                } catch (error) {
                    if (retries > 0) {
                        await new Promise(res => setTimeout(res, delay));
                        return generateGeminiContent(prompt, retries - 1, delay * 2);
                    }
                    console.error("Gemini API Error:", error);
                    return "يبدو أن الشاعر يحتاج للحظة من الإلهام... حاولي مجدداً.";
                } finally {
                    isGenerating = false;
                }
            }

            const updateFlowerStage = (isSilent = false) => {
                const newStage = Math.min(Math.floor(potTapCount / 3), 5);
                if (newStage !== flowerStage || isSilent) {
                    flowerStage = newStage;
                    DOM.flowerStages.forEach((el, index) => {
                        const isCurrentStage = index === flowerStage;
                        el.style.opacity = isCurrentStage ? '1' : '0';
                        if (isCurrentStage && !isSilent) {
                           el.style.animation = 'grow 0.6s ease-out';
                           el.addEventListener('animationend', () => el.style.animation = '', { once: true });
                        }
                    });
                }
            };

            const showGeneratedMessage = async () => {
                if (isGenerating) return;
                clearInterval(typewriterInterval);
                DOM.messageEl.classList.remove('show');
                DOM.messageEl.classList.add('loading');
                DOM.messageEl.textContent = 'الشاعر يجمع كلماته...';
                
                const prompt = "اكتب رسالة حب قصيرة جداً ورومانسية من سطر واحد فقط، باللغة العربية بأسلوب شاعري.";
                const message = await generateGeminiContent(prompt);
                
                typewriter(DOM.messageEl, message);
            };
            
            const loadProgress = () => { const s=localStorage.getItem('heartbloom_pot_taps'); if(s){potTapCount=parseInt(s,10);flowerStage=Math.min(Math.floor(potTapCount/3),5);updateFlowerStage(true);updateCounter();} };
            const saveProgress = () => localStorage.setItem('heartbloom_pot_taps', potTapCount.toString());
            const updateCounter = () => DOM.tapCounterEl.textContent = `نمو الزهرة: ${potTapCount}/15`;
            const createFlyingHearts = () => { const r=DOM.heartTouchArea.getBoundingClientRect(),x=r.left+r.width/2,y=r.top+r.height/2; for(let i=0;i<5;i++){const h=document.createElement('div');h.className='flying-heart';h.innerHTML=DOM.heartTouchArea.querySelector('svg').outerHTML;h.style.left=`${x-15}px`;h.style.top=`${y-15}px`;document.body.appendChild(h);const a=h.animate([{transform:`translate(0,0) scale(1) rotate(0deg)`,opacity:1},{transform:`translate(${(Math.random()-.5)*100}px,-${150+Math.random()*100}px) scale(0) rotate(${(Math.random()-.5)*360}deg)`,opacity:0}],{duration:1800,easing:'cubic-bezier(.1,.9,.2,1)',delay:i*50});a.onfinish=()=>h.remove();} };
            const showBloomMessage = () => { isBloomed=true; DOM.bloomMessageEl.classList.add('show'); DOM.poemButton.classList.add('show'); if(musicPlaying){setTimeout(()=>{let v=DOM.backgroundMusic.volume;const f=setInterval(()=>{v=Math.max(0,v-.05);DOM.backgroundMusic.volume=v;if(v===0){DOM.backgroundMusic.pause();clearInterval(f);}},200);},8000);} };
            
            const toggleMusic = () => {
                if (musicPlaying) {
                    DOM.backgroundMusic.pause();
                    DOM.musicControlEl.textContent = '🎵 تشغيل الموسيقى';
                } else {
                    const playPromise = DOM.backgroundMusic.play();
                    if (playPromise !== undefined) {
                        playPromise.then(() => {
                           DOM.musicControlEl.textContent = '🎵 إيقاف الموسيقى';
                        }).catch(error => {
                            console.error("Music playback failed:", error);
                            DOM.musicControlEl.textContent = '🎵 الموسيقى معطلة';
                        });
                    }
                }
                musicPlaying = !musicPlaying;
            };

            // --- Event Listeners & Init ---
            DOM.startButton.addEventListener('click', () => {
                DOM.startScreen.style.opacity = '0';
                setTimeout(() => DOM.startScreen.style.display = 'none', 800);
                toggleMusic();
                DOM.messageEl.classList.add('show');
            });

            DOM.musicControlEl.addEventListener('click', toggleMusic);
            DOM.heartTouchArea.addEventListener('click', () => { showGeneratedMessage(); createFlyingHearts(); });
            DOM.flowerTouchArea.addEventListener('click', () => {
                if (isBloomed) return;
                DOM.pot.style.animation = 'pot-tap 0.3s ease-in-out';
                DOM.pot.addEventListener('animationend', () => DOM.pot.style.animation = '', { once: true });
                potTapCount++;
                saveProgress();
                updateCounter();
                updateFlowerStage();
                if (potTapCount >= 15 && !isBloomed) setTimeout(showBloomMessage, 500);
            });

            DOM.poemButton.addEventListener('click', async () => {
                if (isGenerating) return;
                clearInterval(typewriterInterval);
                DOM.poemModal.classList.add('show');
                DOM.poemText.textContent = 'الشاعر ينسج قصيدة تليق بكِ...';
                const prompt = "اكتب قصيدة حب قصيرة وجميلة لإيمان، الملقبة بمونه. اجعلها عن كيف أن حبها جعل الحياة تزدهر مثل الزهرة.";
                const poem = await generateGeminiContent(prompt);
                typewriter(DOM.poemText, poem);
            });

            DOM.closePoemModal.addEventListener('click', () => {
                DOM.poemModal.classList.remove('show');
                clearInterval(typewriterInterval);
            });
            
            loadProgress();
        });
    </script>
</body>
</html>

